{"version":3,"file":"index.umd.js","sources":["../src/index.ts"],"sourcesContent":["import got from 'got';\nimport buildUrl, { IQueryParams } from 'build-url-ts';\nimport { createHash } from 'crypto';\n\nexport interface PageView {\n  ipAddress: string;\n  userAgent: string;\n  requestedUrl: string;\n  visitorId?: string;\n  referringUrl?: string;\n}\n\nexport class Client {\n  private readonly apiHost: string;\n\n  constructor(private jarId: string) {\n    this.apiHost = `https://${this.jarId}.s3y.io`;\n  }\n\n  private hash(value: string): string {\n    return createHash('sha256').update(value).digest('hex');\n  }\n\n  private getVisitorId(pageView: PageView): string {\n    const { visitorId, ipAddress, userAgent } = pageView;\n    if (visitorId) {\n      return this.hash([visitorId, this.jarId].join('|'));\n    }\n\n    return this.hash([ipAddress, userAgent, this.jarId].join('|'));\n  }\n\n  public async logPageView(pageView: PageView): Promise<boolean> {\n    const { userAgent, requestedUrl, referringUrl } = pageView;\n\n    const queryParams: IQueryParams = {\n      vid: this.getVisitorId(pageView),\n      ua: userAgent,\n      url: requestedUrl,\n    };\n\n    if (referringUrl) {\n      queryParams['ref'] = referringUrl;\n    }\n\n    const url = buildUrl(this.apiHost, {\n      path: '/count',\n      queryParams,\n    });\n\n    const options = {\n      timeout: {\n        send: 5000,\n      },\n    };\n\n    const { statusCode } = await got(url, options).catch((error) => {\n      throw new Error('failed to log page view' + error.message);\n    });\n    if (statusCode === 204) {\n      return true;\n    }\n    throw new Error('failed to log page view. Status code: ' + statusCode);\n  }\n}\n"],"names":["createHash","buildUrl","got"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAYA,QAAA,MAAA,kBAAA,YAAA;IAGE,IAAA,SAAA,MAAA,CAAoB,KAAa,EAAA;YAAb,IAAK,CAAA,KAAA,GAAL,KAAK,CAAQ;YAC/B,IAAI,CAAC,OAAO,GAAG,UAAA,CAAA,MAAA,CAAW,IAAI,CAAC,KAAK,YAAS,CAAC;SAC/C;QAEO,MAAI,CAAA,SAAA,CAAA,IAAA,GAAZ,UAAa,KAAa,EAAA;IACxB,QAAA,OAAOA,iBAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;SACzD,CAAA;QAEO,MAAY,CAAA,SAAA,CAAA,YAAA,GAApB,UAAqB,QAAkB,EAAA;IAC7B,QAAA,IAAA,SAAS,GAA2B,QAAQ,CAAA,SAAnC,EAAE,SAAS,GAAgB,QAAQ,CAAA,SAAxB,EAAE,SAAS,GAAK,QAAQ,UAAb,CAAc;IACrD,QAAA,IAAI,SAAS,EAAE;IACb,YAAA,OAAO,IAAI,CAAC,IAAI,CAAC,CAAC,SAAS,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;IACrD,SAAA;IAED,QAAA,OAAO,IAAI,CAAC,IAAI,CAAC,CAAC,SAAS,EAAE,SAAS,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;SAChE,CAAA;QAEY,MAAW,CAAA,SAAA,CAAA,WAAA,GAAxB,UAAyB,QAAkB,EAAA;;;;;;IACjC,wBAAA,SAAS,GAAiC,QAAQ,CAAzC,SAAA,EAAE,YAAY,GAAmB,QAAQ,CAAA,YAA3B,EAAE,YAAY,GAAK,QAAQ,aAAb,CAAc;IAErD,wBAAA,WAAW,GAAiB;IAChC,4BAAA,GAAG,EAAE,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC;IAChC,4BAAA,EAAE,EAAE,SAAS;IACb,4BAAA,GAAG,EAAE,YAAY;6BAClB,CAAC;IAEF,wBAAA,IAAI,YAAY,EAAE;IAChB,4BAAA,WAAW,CAAC,KAAK,CAAC,GAAG,YAAY,CAAC;IACnC,yBAAA;IAEK,wBAAA,GAAG,GAAGC,4BAAQ,CAAC,IAAI,CAAC,OAAO,EAAE;IACjC,4BAAA,IAAI,EAAE,QAAQ;IACd,4BAAA,WAAW,EAAA,WAAA;IACZ,yBAAA,CAAC,CAAC;IAEG,wBAAA,OAAO,GAAG;IACd,4BAAA,OAAO,EAAE;IACP,gCAAA,IAAI,EAAE,IAAI;IACX,6BAAA;6BACF,CAAC;4BAEqB,OAAM,CAAA,CAAA,YAAAC,uBAAG,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC,KAAK,CAAC,UAAC,KAAK,EAAA;oCACzD,MAAM,IAAI,KAAK,CAAC,yBAAyB,GAAG,KAAK,CAAC,OAAO,CAAC,CAAC;IAC7D,6BAAC,CAAC,CAAA,CAAA;;IAFM,wBAAA,UAAU,GAAK,CAAA,EAErB,CAAA,IAAA,EAAA,EAFgB,UAAA,CAAA;4BAGlB,IAAI,UAAU,KAAK,GAAG,EAAE;IACtB,4BAAA,OAAA,CAAA,CAAA,aAAO,IAAI,CAAC,CAAA;IACb,yBAAA;IACD,wBAAA,MAAM,IAAI,KAAK,CAAC,wCAAwC,GAAG,UAAU,CAAC,CAAC;;;;IACxE,KAAA,CAAA;QACH,OAAC,MAAA,CAAA;IAAD,CAAC,EAAA;;;;;;;;;;"}