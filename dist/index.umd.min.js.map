{"version":3,"file":"index.umd.min.js","sources":["../src/index.ts"],"sourcesContent":["import got from 'got';\nimport buildUrl, { IQueryParams } from 'build-url-ts';\nimport { createHmac } from 'crypto';\nimport { matches } from 'ip-matching';\n\nexport interface PageView {\n  ipAddress: string;\n  userAgent: string;\n  requestedUrl: string;\n  visitorId?: string;\n  referringUrl?: string;\n}\n\nexport class Client {\n  private readonly jarId: string;\n  private readonly apiHost: string;\n  private ipBlacklistPatterns: string[] = [];\n  constructor(private apiKey: string, private readonly salt: string) {\n    this.jarId = this.getJarId();\n    this.apiHost = `https://${this.jarId}.s3y.io`;\n  }\n\n  private hash(value: string): string {\n    const hmac = createHmac('sha256', this.salt);\n    return hmac.update(Buffer.from(value, 'utf-8')).digest('hex');\n  }\n\n  private getVisitorId(pageView: PageView): string {\n    const { visitorId, ipAddress, userAgent } = pageView;\n    if (visitorId) {\n      return this.hash([visitorId, this.jarId].join('|'));\n    }\n\n    return this.hash([ipAddress, userAgent, this.jarId].join('|'));\n  }\n\n  private getJarId(): string {\n    const parts = Buffer.from(this.apiKey, 'base64')\n      .toString('ascii')\n      .split('|');\n    if (parts.length > 0) {\n      new Error('failed to extract jarId from apiKey');\n    }\n    return parts[0] as string;\n  }\n\n  public async logPageView(pageView: PageView): Promise<boolean> {\n    const { userAgent, requestedUrl, referringUrl, ipAddress } = pageView;\n\n    if (this.isBlockedIp(ipAddress)) {\n      return false;\n    }\n\n    const queryParams: IQueryParams = {\n      vid: this.getVisitorId(pageView),\n      ua: userAgent,\n      url: requestedUrl,\n    };\n\n    if (referringUrl) {\n      queryParams['ref'] = referringUrl;\n    }\n\n    const url = buildUrl(this.apiHost, {\n      path: '/count',\n      queryParams,\n    });\n\n    const options = {\n      timeout: {\n        send: 5000,\n      },\n      headers: {\n        Authorization: `Bearer ${this.apiKey}`,\n      },\n    };\n\n    const { statusCode } = await got(url, options).catch((error) => {\n      throw new Error('failed to log page view' + error.message);\n    });\n    if (statusCode === 204) {\n      return true;\n    }\n    throw new Error('failed to log page view. Status code: ' + statusCode);\n  }\n\n  private isBlockedIp(ipAddress: string): boolean {\n    for (const pattern of this.ipBlacklistPatterns) {\n      if (matches(ipAddress, pattern)) return true;\n    }\n    return false;\n  }\n\n  public blacklistIpRange(pattern: string) {\n    this.ipBlacklistPatterns.push(pattern);\n  }\n}\n"],"names":["Client","apiKey","salt","this","ipBlacklistPatterns","jarId","getJarId","apiHost","concat","prototype","hash","value","createHmac","update","Buffer","from","digest","getVisitorId","pageView","visitorId","ipAddress","userAgent","join","parts","toString","split","length","logPageView","requestedUrl","referringUrl","isBlockedIp","queryParams","vid","ua","url","buildUrl","path","options","timeout","send","headers","Authorization","got","catch","error","Error","message","statusCode","_a","sent","_i","pattern","matches","blacklistIpRange","push"],"mappings":";;;;;6zDAaA,IAAAA,EAAA,WAIE,SAAoBA,EAAAC,EAAiCC,GAAjCC,KAAMF,OAANA,EAAiCE,KAAID,KAAJA,EAD7CC,KAAmBC,oBAAa,GAEtCD,KAAKE,MAAQF,KAAKG,WAClBH,KAAKI,QAAU,WAAAC,OAAWL,KAAKE,gBAChC,CA4EH,OA1EUL,EAAIS,UAAAC,KAAZ,SAAaC,GAEX,OADaC,EAAUA,WAAC,SAAUT,KAAKD,MAC3BW,OAAOC,OAAOC,KAAKJ,EAAO,UAAUK,OAAO,QAGjDhB,EAAYS,UAAAQ,aAApB,SAAqBC,GACX,IAAAC,EAAoCD,EAAQC,UAAjCC,EAAyBF,EAAQE,UAAtBC,EAAcH,YAC5C,OAAIC,EACKhB,KAAKO,KAAK,CAACS,EAAWhB,KAAKE,OAAOiB,KAAK,MAGzCnB,KAAKO,KAAK,CAACU,EAAWC,EAAWlB,KAAKE,OAAOiB,KAAK,OAGnDtB,EAAAS,UAAAH,SAAR,WACE,IAAMiB,EAAQT,OAAOC,KAAKZ,KAAKF,OAAQ,UACpCuB,SAAS,SACTC,MAAM,KAIT,OAHIF,EAAMG,OAGHH,EAAM,IAGFvB,EAAWS,UAAAkB,YAAxB,SAAyBT,iHAGvB,OAFQG,EAAqDH,EAAQG,UAAlDO,EAA0CV,EAA9BU,aAAEC,EAA4BX,EAAhBW,aAAET,EAAcF,YAEzDf,KAAK2B,YAAYV,GACnB,CAAA,GAAO,IAGHW,EAA4B,CAChCC,IAAK7B,KAAKc,aAAaC,GACvBe,GAAIZ,EACJa,IAAKN,GAGHC,IACFE,EAAiB,IAAIF,GAGjBK,EAAMC,EAAAA,QAAShC,KAAKI,QAAS,CACjC6B,KAAM,SACNL,YAAWA,IAGPM,EAAU,CACdC,QAAS,CACPC,KAAM,KAERC,QAAS,CACPC,cAAe,UAAAjC,OAAUL,KAAKF,UAIL,CAAA,EAAAyC,UAAIR,EAAKG,GAASM,OAAM,SAACC,GACpD,MAAM,IAAIC,MAAM,0BAA4BD,EAAME,QACnD,aACD,GAAmB,OAHXC,EAAeC,EAErBC,OAFgBF,YAIhB,MAAA,CAAA,GAAO,GAET,MAAM,IAAIF,MAAM,yCAA2CE,SAC5D,EAEO/C,EAAWS,UAAAqB,YAAnB,SAAoBV,GAClB,IAAsB,IAAA8B,EAAA,EAAAF,EAAA7C,KAAKC,oBAAL8C,EAAAF,EAAAtB,OAAAwB,IAA0B,CAA3C,IAAMC,EAAOH,EAAAE,GAChB,GAAIE,EAAOA,QAAChC,EAAW+B,GAAU,OAAO,CACzC,CACD,OAAO,GAGFnD,EAAgBS,UAAA4C,iBAAvB,SAAwBF,GACtBhD,KAAKC,oBAAoBkD,KAAKH,IAEjCnD,CAAD"}